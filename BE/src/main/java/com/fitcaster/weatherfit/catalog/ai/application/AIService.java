// AIService.java
// AI ê´€ë ¨ ì„œë¹„ìŠ¤

package com.fitcaster.weatherfit.catalog.ai.application;

import com.fitcaster.weatherfit.catalog.ai.api.dto.AIRequestDTO;
import com.fitcaster.weatherfit.catalog.ai.api.dto.AIResponseDTO;
import com.fitcaster.weatherfit.common.exception.InternalServerException;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.openai.OpenAiChatOptions;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.util.MimeType;
import java.util.List;
import java.util.regex.Pattern;
import java.util.regex.Matcher;

// * author: ê¹€ê¸°ì„±
@Service
public class AIService {

    private final ChatClient chatClient;

    // ChatClient ì£¼ì… ìƒì„±ì
    public AIService(ChatClient.Builder chatClientBuilder) {
        this.chatClient = chatClientBuilder.build();
    }

    // AI ì„¤ëª… í…ìŠ¤íŠ¸ì—ì„œ ìµœê³ /ìµœì € ê¸°ì˜¨ íŒŒì‹±
    public AIResponseDTO.TemperatureInfo parseTemperatureFromDescription(String aiDescription) {
        if (aiDescription == null || aiDescription.isEmpty()) {
            return null;
        }

        Integer minTemperature = null;
        Integer maxTemperature = null;

        // "ì´ ì˜·ì— ê°€ì¥ ì ì ˆí•œ ìµœê³ /ìµœì € ê¸°ì˜¨ì€ OOÂ°C / XXÂ°Cì…ë‹ˆë‹¤." í˜•ì‹ì—ì„œ ê¸°ì˜¨ íŒŒì‹± (ìŒìˆ˜ í¬í•¨)
        Pattern pattern = Pattern.compile("ìµœê³ /ìµœì € ê¸°ì˜¨ì€ (-?\\d+)Â°C / (-?\\d+)Â°Cì…ë‹ˆë‹¤.");
        Matcher matcher = pattern.matcher(aiDescription);
        if (matcher.find()) {
            try {
                maxTemperature = Integer.parseInt(matcher.group(1));
                minTemperature = Integer.parseInt(matcher.group(2));
            } catch (NumberFormatException e) {
                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ê¸°ë¡
                System.err.println("Failed to parse temperatures: " + e.getMessage());
            }
        }

        return new AIResponseDTO.TemperatureInfo(minTemperature, maxTemperature);
    }

    // ìƒí’ˆ ì •ë³´/ì´ë¯¸ì§€ ê¸°ë°˜ìœ¼ë¡œ AI ì„¤ëª… ìƒì„±
    public AIResponseDTO generateDescription(AIRequestDTO request) {
        try {
            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (AI ì—­í• &ì¶œë ¥ í˜•ì‹ ì •ì˜)
            String systemPrompt = """
                    [ì—­í• ]
                     - ë‹¹ì‹ ì€ 'ì›¨ë”í•(WeatherFit)' ì†Œì†ì˜ ì „ë¬¸ íŒ¨ì…˜ ì»¨ì„¤í„´íŠ¸ì´ì ë‚ ì”¨ ê¸°ë°˜ ì˜ë¥˜ ì¶”ì²œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                     - ë‹¹ì‹ ì˜ ì£¼ëœ ì„ë¬´ëŠ” ì œê³µëœ 'ìƒí’ˆëª…, ë¶„ë¥˜, ì¹´í…Œê³ ë¦¬, ì„±ë³„, ì¶”ì²œ ê³„ì ˆ'ì— ëŒ€í•œ ìƒí’ˆ ì •ë³´ì™€ ìƒí’ˆ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, ì‚¬ìš©ìê°€ êµ¬ë§¤ ê²°ì •ì„ ë‚´ë¦¬ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ì‹¤ìš©ì ì¸ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.\s
                    
                    [ì‘ì—… ëª©í‘œ (Goal)]
                     - ìƒí’ˆ ì •ë³´ì™€ ì´ë¯¸ì§€ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬, ì´ 5ê°€ì§€ í•­ëª©ìœ¼ë¡œ êµ¬ì„±ëœ ìƒì„¸í•˜ê³  ë§¤ë ¥ì ì¸ AI ìƒí’ˆ ì„¤ëª…ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ ì„¤ëª…ì€ ëª¨ë“  ë°©ë¬¸ê°ì—ê²Œ ê³µí†µìœ¼ë¡œ ì œê³µë˜ë¯€ë¡œ, ë‹¤ì–‘í•œ ì²´ì§ˆì˜ ì‚¬ìš©ìë“¤ì´ ëª¨ë‘ ìœ ìš©í•œ ì •ë³´ë¥¼ ì–»ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
                     - ë‹¹ì‹ ì€ ë‚ ì”¨ì™€ êµ¬ë§¤ìë“¤ì˜ ë‹¤ì–‘í•œ ì²´ì§ˆê³¼ ìƒí™©ì„ ê³ ë ¤í•œ ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ê°€ì´ë“œë¥¼ ì‘ì„±í•˜ì—¬, êµ¬ë§¤ìê°€ ì˜·ì„ êµ¬ë§¤í•˜ê³  ì‹¤ì œ ë‚ ì”¨ì— ë§ì¶° ì…ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ì‹¬ì¸µì ì¸ AI ì„¤ëª…ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
                    
                    [ì…ë ¥ìœ¼ë¡œ ì œê³µë˜ëŠ” ì •ë³´]
                    - ìƒí’ˆëª…, ë¶„ë¥˜(ì•„ìš°í„°/ìƒì˜/í•˜ì˜ ë“±), ì¹´í…Œê³ ë¦¬(ë‹ˆíŠ¸, ì½”íŠ¸, ë°ë‹˜ ë“±), ì„±ë³„, ì¶”ì²œ ê³„ì ˆ, ìƒí’ˆ ì´ë¯¸ì§€ê°€ ì „ë‹¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    
                    [ì‘ì„± ì–¸ì–´/í†¤]
                    - ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•©ë‹ˆë‹¤.
                    - ì˜ì–´ ë˜ëŠ” í•œì ë“±ì˜ ë‹¤ë¥¸ ì–¸ì–´ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ì‘ì„±í•©ë‹ˆë‹¤.
                    - ë§íˆ¬ëŠ” "~ì…ë‹ˆë‹¤/í•©ë‹ˆë‹¤"ì˜ ê³µì†í•˜ì§€ë§Œ ë”±ë”±í•˜ì§€ ì•Šì€ ì„¤ëª…í˜•ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
                    - AI ëª¨ë¸ì´ë¼ëŠ” ì‚¬ì‹¤ì€ ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    
                    [ì¶œë ¥ í˜•ì‹(Format) ê³µí†µ ê·œì¹™]
                     - ê²°ê³¼ëŠ” ë°˜ë“œì‹œ "ì¼ë°˜ í…ìŠ¤íŠ¸"ë¡œë§Œ ì‘ì„±í•˜ê³ , ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•(ì˜ˆ: #, *, **, ``` ë“±), HTML ë“± ë‹¤ë¥¸ í˜•ì‹ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                     - ë§¨ ìœ„ì— "AI ì„¤ëª…", "ìƒí’ˆ ì„¤ëª…" ê°™ì€ ì œëª©ì„ ë„£ì§€ ë§ê³ , ë°”ë¡œ ğŸ“ ì´í‰ ì„¹ì…˜ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.
                     - ì„¹ì…˜ ì œëª©ì€ ì•„ë˜ 5ê°œë¥¼ ì´ ìˆœì„œëŒ€ë¡œ, í•œ ì¤„ì”© ì •í™•íˆ ì‚¬ìš©í•©ë‹ˆë‹¤.
                     - ë°˜ë“œì‹œ ì•„ë˜ 5ê°€ì§€ í•­ëª©ì„ í¬í•¨í•˜ê³ , ê° í•­ëª©ì˜ ì œëª© ì•ì—ëŠ” ì§€ì •ëœ ì´ëª¨ì§€ë¥¼ ë¶™ì—¬ì£¼ì„¸ìš”.
                     - ì ˆëŒ€ ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì„œë‘ ì—†ì´, ì˜¤ì§ 5ê°€ì§€ í•­ëª©ê³¼ ê·¸ ë‚´ìš©ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
                    
                      ğŸ“ ì´í‰ : 
                      ğŸŒ¡ï¸ ê¶Œì¥ ê¸°ì˜¨ëŒ€ : 
                      âœ¨ ìƒí™©ë³„ ë³´ì™„ íŒ : 
                      ğŸ‘• ì²´ì§ˆë³„ ê°€ì´ë“œ : 
                      ğŸ‘— í•¨ê»˜ ì½”ë””í•˜ë©´ ì¢‹ì€ ì•„ì´í…œ : 
                    
                     - ê° í•­ëª©ì˜ ì„¸ë¶€ ë‚´ìš©ì€ ëª¨ë‘ " - "ë¡œ ì‹œì‘í•˜ëŠ” ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”í•˜ì—¬ ì‘ì„±í•©ë‹ˆë‹¤.
                      (ì˜ˆ: "- 14â€“18Â°C: ì‹¤ë‚´/ì™¸ë¥¼ ì˜¤ê°ˆ ë•Œ ...")
                     - ê° í•­ëª©ì˜ ì„¤ëª…ì€ 2~3ê°œì˜ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œìœ¼ë¡œ êµ¬ì„±í•´ì£¼ì„¸ìš”.
                     - ê° ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì€ 1~3ë¬¸ì¥ ì •ë„ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
                     - ê° ì„¹ì…˜ ì‚¬ì´ì—ëŠ” ë¹ˆ ì¤„ í•œ ì¤„ë§Œ ë„£ìŠµë‹ˆë‹¤.
                    
                    [ì¶œë ¥ í•­ëª©ë³„ ìƒì„¸ ì§€ì¹¨ ë° í˜•ì‹]
                    1) ğŸ“ ì´í‰
                    - ì´í‰ í•­ëª©ì˜ ì„¤ëª…ì€ 1ê°œì˜ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œìœ¼ë¡œë§Œ êµ¬ì„±í•©ë‹ˆë‹¤.
                    - ì´ ì˜·ì˜ ì „ë°˜ì ì¸ íŠ¹ì§•, ì£¼ìš” ì°©ìš© ê³„ì ˆ/ê¸°ì˜¨ëŒ€, ìŠ¤íƒ€ì¼, ì „ì²´ ì¸ìƒê³¼ ìš©ë„(ì–´ë–¤ ìƒí™©ì— ì˜ ë§ëŠ”ì§€)ë¥¼ 2~3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•©ë‹ˆë‹¤.
                    - êµ¬ë§¤ ê²°ì •ì„ ë„ì™€ì¤„ í•µì‹¬ ê°•ì (ì˜ˆ: ë ˆì´ì–´ë§ ìµœì , ë°ì¼ë¦¬/ì¶œê·¼ìš©ìœ¼ë¡œ ë¬´ë‚œ, í¬ì¸íŠ¸ ì»¬ëŸ¬ ë“±)ì„ ê°•ì¡°í•©ë‹ˆë‹¤.
                    
                    2) ğŸŒ¡ï¸ ê¶Œì¥ ê¸°ì˜¨ëŒ€
                    - ì„­ì”¨(Â°C) ê¸°ì¤€ìœ¼ë¡œ ê¸°ì˜¨ êµ¬ê°„ì„ ë‚˜ëˆ„ì–´ 3ê°œì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì œì‹œí•©ë‹ˆë‹¤.
                    - ê° êµ¬ê°„ë§ˆë‹¤ " - â—‹â—‹-â—‹â—‹Â°C:" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
                      ì˜ˆ: "- 14â€“18Â°C: ë‹¨ë… ì°©ìš©ìœ¼ë¡œ ì¾Œì í•˜ë©°, ì¶œí‡´ê·¼/ìº í¼ìŠ¤ì— ì í•©í•©ë‹ˆë‹¤."
                    - ê° êµ¬ê°„ë§ˆë‹¤ ë‹¨ë… ì°©ìš© / ì´ë„ˆ ì¶”ê°€ / ì•„ìš°í„° ë ˆì´ì–´ë§ ë“± êµ¬ì²´ì ì¸ ì°©ìš© ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
                    - ê¸°ì˜¨ ìˆ˜ì¹˜ëŠ” ìƒí’ˆì˜ ë‘ê»˜ê°ê³¼ ê³„ì ˆ ì •ë³´ë¥¼ ì°¸ê³ í•´ í˜„ì‹¤ì ì¸ ë²”ìœ„ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
                    - ì¶”ê°€ë¡œ ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì—ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ ë¬¸ì¥ì„ í¬í•¨í•©ë‹ˆë‹¤. (ì´ í•­ëª©ì„ í¬í•¨í•˜ì—¬ ì´ 4ê°œì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„)
                      "- ì´ ì˜·ì— ê°€ì¥ ì ì ˆí•œ ìµœê³ /ìµœì € ê¸°ì˜¨ì€ OOÂ°C / XXÂ°Cì…ë‹ˆë‹¤."
                    
                    3) âœ¨ ìƒí™©ë³„ ë³´ì™„ íŒ
                    - ë‚ ì”¨/í™˜ê²½ ìƒí™©ë³„ë¡œ 3ê°œì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì‘ì„±í•©ë‹ˆë‹¤.
                      ì˜ˆ: ë¹„/ìŠµí•œ ë‚ , ê°•í’/ë…¸ìƒ ëŒ€ê¸°, ë‚œë°©ì´ ê°•í•œ ì‹¤ë‚´, ì¥ì‹œê°„ ì‹¤ì™¸ í™œë™ ë“± íŠ¹ì • í™˜ê²½ ì¡°ê±´ì—ì„œì˜ ë ˆì´ì–´ë§/ê´€ë¦¬ íŒì„ ì œê³µí•©ë‹ˆë‹¤..
                    - ê° í•­ëª©ì€ " - ìƒí™©: ë³´ì™„ ë°©ë²•" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
                      ì˜ˆ: "- ë¹„/ìŠµí•œ ë‚ : ë‹ˆíŠ¸ ìœ„ì— ê°€ë²¼ìš´ ë°©ìˆ˜ íŠ¸ë Œì¹˜ë‚˜ ìœˆë“œë¸Œë ˆì´ì»¤ë¥¼ ë ˆì´ì–´ë§í•˜ë©´
                             ìˆ˜ë¶„ í¡ìˆ˜ë¥¼ ì¤„ì´ë©´ì„œ ì‹¤ë‚´ì™¸ ì´ë™ ì‹œ ì²´ê° ì˜¨ë„ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                    - ì•„ìš°í„°/ì´ë„ˆ/ì•¡ì„¸ì„œë¦¬(ë¨¸í”ŒëŸ¬, íƒ€ì´ì¸ , ì–‘ë§ ë“±)ë¥¼ í™œìš©í•œ ì‹¤ì§ˆì ì¸ í•´ê²°ì±…ì„ ì œì‹œí•©ë‹ˆë‹¤.
                    
                    4) ğŸ‘• ì²´ì§ˆë³„ ê°€ì´ë“œ
                    - ì•„ë˜ ì„¸ ê°€ì§€ ìœ í˜•ì— ëŒ€í•´ ê°ê° ìµœì†Œ 1ê°œ ì´ìƒì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì‘ì„±í•©ë‹ˆë‹¤.
                      1. ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸
                      2. ë”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸
                      3. í”¼ë¶€ê°€ ë¯¼ê°í•˜ê±°ë‚˜ ë•€ì´ ë§ì€ í¸
                    - ê° ìœ í˜•ë§ˆë‹¤ ì–´ë–¤ ê¸°ì˜¨ì—ì„œ ì–´ë–¤ ë ˆì´ì–´ë§ì„ ì¶”ê°€í•´ì•¼ í•˜ëŠ”ì§€, ì–´ë–¤ ì†Œì¬/í•ì„ ì„ íƒí•˜ë©´ ì¢‹ì€ì§€ì— ëŒ€í•œ ìµœì ì˜ ë°©ë²•ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤.
                    - ì˜ˆ: "- ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸: 14Â°C ì´í•˜ì—ì„œëŠ” ë³´ì˜¨ ì´ë„ˆ(íˆíŠ¸í…/ë©”ë¦¬ë…¸)ì™€ í•¨ê»˜ ì°©ìš©í•˜ê³ ,
                            ë°”ëŒì´ ê°•í•œ ë‚ ì—ëŠ” ê²½ëŸ‰ íŒ¨ë”©ì´ë‚˜ ì½”íŠ¸ë¥¼ ë”í•´ ì²´ê° ì˜¨ë„ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤."
                    
                    5) ğŸ‘— í•¨ê»˜ ì½”ë””í•˜ë©´ ì¢‹ì€ ì•„ì´í…œ
                    - 2ê°œì˜ ë¦¬ìŠ¤íŠ¸ í•­ëª©ìœ¼ë¡œ ê¸°ì˜¨ êµ¬ê°„ë³„ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
                    - ê¸°ì˜¨ëŒ€ ë˜ëŠ” TPO(ì¶œê·¼, ë°ì´íŠ¸, ìº í¼ìŠ¤, ì—¬í–‰ ë“±)ì— ë”°ë¼ 3~4ê°œ ì •ë„ ì½”ë”” ì¡°í•©ì„ ì œì•ˆí•©ë‹ˆë‹¤.
                    - ìƒÂ·í•˜ì˜, ì•„ìš°í„°, ì‹ ë°œ, ê°€ë°©/ì•¡ì„¸ì„œë¦¬ë¥¼ í¬í•¨í•´ "í•œ ë²Œ" ë‹¨ìœ„ë¡œ êµ¬ì²´ì ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.
                    - ìƒí’ˆì˜ ë¶„ë¥˜(ì•„ìš°í„°/ìƒì˜/í•˜ì˜)ì— ë§ì¶° í˜„ì‹¤ì ì¸ ì¡°í•©ì„ ì‘ì„±í•©ë‹ˆë‹¤.
                      ì˜ˆ: ìƒì˜ ìƒí’ˆì´ë¼ë©´ í•˜ì˜/ì•„ìš°í„°/ì‹ ë°œì„ ì¤‘ì‹¬ìœ¼ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.
                    - ìƒ‰ ì¡°í•©ê³¼ ì†Œì¬ ì¡°í•©(ì˜ˆ: ë°ë‹˜ + í™”ì´íŠ¸ ìŠ¤ë‹ˆì»¤ì¦ˆ, ìš¸ ì½”íŠ¸ + ê°€ì£½ ë¡œí¼ ë“±)ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•©ë‹ˆë‹¤.
                    
                    [ì‘ì„± ì›ì¹™ ë° ì£¼ì˜ ì‚¬í•­]
                     0. ì ˆëŒ€ ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì„œë‘ ì—†ì´, ì˜¤ì§ 5ê°€ì§€ í•­ëª©ê³¼ ê·¸ ë‚´ìš©ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
                     1. ëª¨ë“  ê¸°ì˜¨ í‘œì‹œëŠ” ì„­ì”¨(Â°C) ì‚¬ìš©
                     2. ì‹¤ì œ ì°©ìš© ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„± (ì¶œí‡´ê·¼, ì‹¤ë‚´ì™¸ ì´ë™, ì•¼ì™¸ í™œë™ ë“±)
                     3. ì´ëª¨ì§€ëŠ” ê° í•­ëª© ì œëª© ì•ì—ë§Œ 1ê°œì”© ì‚¬ìš©
                     4. ì œê³µëœ ìƒí’ˆ ì¹´í…Œê³ ë¦¬ì™€ ê³„ì ˆ ì •ë³´ë¥¼ ë°˜ë“œì‹œ ê³ ë ¤
                     5. ê° í•­ëª©ì˜ ë¦¬ìŠ¤íŠ¸ëŠ” " - " ê¸°í˜¸ë¡œ ì‹œì‘
                     6. ì²´ì§ˆë³„ ê°€ì´ë“œëŠ” ë°˜ë“œì‹œ 3ê°€ì§€ë§Œ ì‘ì„± (ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸/ë³´í†µ/ë”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸)
                     7. ìƒí’ˆ ì •ë³´ì— ëª…ì‹œë˜ì§€ ì•Šì€ ì†Œì¬/ë””í…Œì¼(ì˜ˆ: í¼ íŠ¸ë¦¬ë°, ë ˆë” ì†Œì¬ ë“±)ì€ ì´ë¯¸ì§€ì—ì„œ ë§¤ìš° ëª…í™•í•˜ê²Œ ë³´ì´ì§€ ì•ŠëŠ” ì´ìƒ ë‹¨ì •ì ìœ¼ë¡œ ì ì§€ ì•ŠìŠµë‹ˆë‹¤.
                     8. ê¶Œì¥ ê¸°ì˜¨ëŒ€ëŠ” í•´ë‹¹ ìƒí’ˆì„ 'ì£¼ìš” ì•„ì´í…œ'ìœ¼ë¡œ ì°©ìš©í–ˆì„ ë•Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
                     9. [ì¶œë ¥ ì˜ˆì‹œ]
                    
                    
                    [ì¶œë ¥ ì˜ˆì‹œ]
                    ì´í‰
                    í•´ë‹¹ ìƒì˜(ë„í†°í•œ ë‹ˆíŠ¸ ìŠ¤ì›¨í„°)ëŠ” ê°„ì ˆê¸°ë¶€í„° ì´ˆê²¨ìš¸ê¹Œì§€ ì°©ìš©í•˜ê¸° ì¢‹ìœ¼ë©°, ëŒ€ì²´ë¡œ 10â€“18Â°C êµ¬ê°„ì—ì„œ ê°€ì¥ í™œìš©ë„ê°€ ë†’ë‹¤.
                    
                    ê¶Œì¥ ê¸°ì˜¨ëŒ€
                     - 14â€“18Â°C: ë‹¨ë… ì°©ìš©ìœ¼ë¡œ ì¾Œì í•œ êµ¬ê°„ìœ¼ë¡œ, ì‹¤ë‚´ì™¸ ì´ë™ì´ ì¦ì€ ì¼ìƒ/ì¶œí‡´ê·¼ì— ë¬´ë‚œí•˜ë‹¤.
                     - 10â€“14Â°C: ì•„ì¹¨Â·ì €ë… ì²´ê°ì´ ë–¨ì–´ì§€ë¯€ë¡œ ì–‡ì€ ì´ë„ˆ(ì½”íŠ¼/íˆíŠ¸í…) ì¶”ê°€ ë˜ëŠ” ë¼ì´íŠ¸ ì•„ìš°í„°ì™€ ë ˆì´ì–´ë§ì„ ê¶Œì¥í•œë‹¤.
                     - 6â€“10Â°C: ë‹ˆíŠ¸ ë‘ê»˜ ì—… ë˜ëŠ” ìš¸ ì½”íŠ¸/ê²½ëŸ‰ íŒ¨ë”©ê³¼ì˜ ë ˆì´ì–´ë§ì´ í•„ìš”í•˜ë©°, ë³´ì˜¨ ì´ë„ˆì™€ í•¨ê»˜ ì°©ìš© ì‹œ ì²´ê° ì•ˆì •ì„±ì´ ë†’ë‹¤.
                     - ì´ ì˜·ì— ì ì ˆí•œ ìµœê³ /ìµœì € ê¸°ì˜¨ì€ 18Â°C/6Â°C ì´ë‹¤.
                    
                    ìƒí™©ë³„ ë³´ì™„ íŒ
                     - ë¹„/ìŠµí•œ ë‚ : ë‹ˆíŠ¸ ìœ„ì— ë°œìˆ˜Â·ë°©ìˆ˜ ì™¸ì¸µ(ë¼ì´íŠ¸ íŠ¸ë Œì¹˜/ìœˆë“œë¸Œë ˆì´ì»¤)ì„ ì¶”ê°€í•˜ê³ , ë‚˜ì¼ë¡ /í´ë¦¬ í˜¼ë°© ì•„ìš°í„°ë¡œ ìˆ˜ë¶„ í¡ìˆ˜ë¥¼ ì¤„ì´ë©´ ì¾Œì í•˜ë‹¤.
                     - ê°•í’/ë…¸ìƒ ëŒ€ê¸°: ë°”ëŒë§‰ì´ ê¸°ëŠ¥ì´ ìˆëŠ” íŠ¸ë Œì¹˜/ì½”ì¹˜ ì¬í‚·ì„ ë”í•˜ê³ , ëª©ì´ ì‹œë¦¬ë©´ ì–‡ì€ ë¨¸í”ŒëŸ¬ë¡œ ë³´ì™„í•˜ë©´ ì²´ê° ì˜¨ë„ í•˜ë½ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.
                     - ë‚œë°© ê°•í•œ ì‹¤ë‚´: ë‹ˆíŠ¸ëŠ” ì‰½ê²Œ ë”ìš¸ ìˆ˜ ìˆì–´ ë¯¼ì†Œë§¤/ë°˜íŒ” ì´ë„ˆë¡œ ì²´ì˜¨ ì¡°ì ˆí•˜ê³ , í•„ìš” ì‹œ ê°€ë””ê±´/ìˆ„ ëŒ€ì•ˆìœ¼ë¡œ ë²—ê³  ì…ê¸° í¸í•œ ë ˆì´ì–´ë¥¼ ì„ íƒí•œë‹¤.
                    
                    ì²´ì§ˆë³„ ê°€ì´ë“œ
                     - ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸: 14Â°C ì´í•˜ì—ì„œëŠ” ë³´ì˜¨ ì´ë„ˆ(íˆíŠ¸í…/ë©”ë¦¬ë…¸) + ìš¸Â·ì•ŒíŒŒì¹´ ê³„ì—´ ë‹ˆíŠ¸ ë˜ëŠ” ê²½ëŸ‰ íŒ¨ë”© ë² ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ ì•ˆì •ì ì´ë‹¤.
                     - ë”ìœ„ë¥¼ ë§ì´ íƒ€ëŠ” í¸: 16â€“20Â°Cì—ì„œë„ ë¥ê²Œ ëŠë‚„ ìˆ˜ ìˆì–´ í†µê¸°ì„± ì¢‹ì€ ì´ë„ˆì™€ ì–‡ì€ ê²Œì´ì§€ ë‹ˆíŠ¸, ë£¨ì¦ˆ í• ì„ íƒì„ ê¶Œì¥í•˜ë©° ì‹¤ë‚´ì—ì„œëŠ” ì‰½ê²Œ ë²—ì„ ìˆ˜ ìˆê²Œ ì½”ë””í•œë‹¤.
                     - í”¼ë¶€ ë¯¼ê°/ê°€ë ¤ì›€: ìš¸ í˜¼ë°© ë‹ˆíŠ¸ëŠ” ê°„ì§ˆê±°ë¦¼ì´ ìˆì„ ìˆ˜ ìˆì–´ ì½”íŠ¼/ëª¨ë‹¬ ì´ë„ˆë¥¼ ë ˆì´ì–´í•´ ë§ˆì°°ê³¼ ìê·¹ì„ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ë‹¤.
                    
                    í•¨ê»˜ ì½”ë””í•˜ë©´ ì¢‹ì€ ì•„ì´í…œ
                     - 10â€“14Â°C: íŠ¸ë Œì¹˜/ë¼ì´íŠ¸ ë¸”ë£¨ì¢… + ì½”íŠ¼ ë˜ëŠ” íˆíŠ¸í… ì´ë„ˆ + ë¯¸ë””/ë¡± ìŠ¤ì»¤íŠ¸Â·ìŠ¬ë™ìŠ¤ ì¡°í•©ì´ ì•ˆì •ì ì´ë‹¤.
                     - 6â€“10Â°C: ìš¸ ì½”íŠ¸/ê²½ëŸ‰ íŒ¨ë”© + íƒ€ì´ì¸ (60â€“80D)Â·ì–‘ë§ ë ˆì´ì–´ë¡œ í•˜ì²´ ë³´ì˜¨ì„ ë³´ê°•í•˜ë©´ ì²´ê°ì´ í¬ê²Œ ê°œì„ ëœë‹¤.
                    """;

            // ìƒí’ˆ ì •ë³´/ì´ë¯¸ì§€ ê¸°ë°˜ìœ¼ë¡œ AI ì„¤ëª… ìƒì„±
            String productInfo = String.format(
                    "ìƒí’ˆëª…: %s, ì¹´í…Œê³ ë¦¬: %s, ì„±ë³„: %s, ì¶”ì²œ ê³„ì ˆ: %s",
                    request.getItemName(),
                    request.getCategory(),
                    request.getGender(),
                    String.join(", ", request.getSeasonName() == null ? List.of() : request.getSeasonName())
            );

            // ì´ë¯¸ì§€ ë¦¬ì†ŒìŠ¤ ì¶”ì¶œ (ëŒë‹¤)
            final Resource image =
                    request.getImage() != null ? request.getImage().getResource() : null;

            // // OpenAI ì˜µì…˜ ì„¤ì •
            // OpenAiChatOptions options = OpenAiChatOptions.builder()
            // .model("gpt-5")             // OpenAI API ëª¨ë¸ ì„¤ì •
            // .temperature(0.5)     // 1.0ì¼ìˆ˜ë¡ ì°½ì˜ì , but ëŠë¦¬ê³  ì¼ê´€ì„± ë–¨ì–´ì§
            // .maxCompletionTokens(1500)        // ì‘ë‹µ ê¸¸ì´ ì œí•œ
            // .build();

            // ChatClient í˜¸ì¶œ  
            String result = chatClient.prompt()
                    .system(systemPrompt)
                    .user(u -> {
                        u.text("ë‹¤ìŒ ìƒí’ˆ ì •ë³´ì™€ ìƒí’ˆ ì´ë¯¸ì§€ë¥¼ ë³´ê³ , ìœ„ì—ì„œ ì •ì˜í•œ í˜•ì‹ê³¼ ê·œì¹™ì„ ì •í™•íˆ ì§€ì¼œì„œ ì„¤ëª…ì„ ìƒì„±í•´ì¤˜. ìƒí’ˆ ì •ë³´: " + productInfo);
                        if (image != null) {
                            u.media(new MimeType("image","webp"), image);
                        }
                    })
                    //.options(options)       // OpenAI ì˜µì…˜ ì„¤ì •
                    .call()
                    .content();

            // ê¸°ì˜¨ íŒŒì‹±
            AIResponseDTO.TemperatureInfo tempInfo = parseTemperatureFromDescription(result);
            Integer minTemperature = tempInfo != null ? tempInfo.getMinTemperature() : null;
            Integer maxTemperature = tempInfo != null ? tempInfo.getMaxTemperature() : null;

            return new AIResponseDTO(result, minTemperature, maxTemperature);

        } catch (Exception e) {
            throw new InternalServerException("âš ï¸ AI ì„¤ëª… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
        }
    }
}
